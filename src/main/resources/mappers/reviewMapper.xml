<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.bookdabang.mapper.ReviewMapper" >

	<select id="selectAllReview" resultType="ReviewVO">
		select * from review where productNo = #{prodNo} order by writedate desc limit #{startNum},#{postPerPage}
	</select>
	
	<select id="selectAllComments" resultType="ReviewComment">
		select * from review_comment where reviewNo = #{rno} order by ref asc,step asc, reforder desc
	</select>
	
	<insert id="insertComment">
		 insert into review_comment(commenter,comment,reviewNo,ref) values (#{commenter},#{comment},#{reviewNo},#{ref})
	</insert>
	
	<update id="updateCommentNum">
		update review set commentNum = commentNum + 1 where reviewNo = #{reviewNo}
	</update>
	
	<select id="selectNextRef" resultType="int">
		select max(commentNo) + 1 as nextRef from review_comment
	</select>
	
	<update id="updatePrevReply">
		update review_comment set reforder = reforder + 1 where ref = #{ref} and reforder > #{reforder}
	</update>
	
	<insert id="insertReply">
		 insert into review_comment(commenter,comment,reviewNo,ref,step,reforder)
		  values (#{commenter},#{comment},#{reviewNo},#{ref},#{step} + 1, #{reforder} + 1)
	</insert>
	
	<select id="selectRecommend" resultType="int">
		select reviewNo from recommend where userId=#{userId} and reviewNo is not null
	</select>
	
	<update id="updateRecommend">
		update review set 
		<if test="change == 1">
			recommendNum = recommendNum + 1 
		</if>
		<if test="change == 2">
			recommendNum = recommendNum - 1 
		</if>
		 where reviewNo = #{reviewNo}
	</update>
	
	<insert id="insertRecommend">
		 insert into recommend(userId,reviewNo) values (#{userId},#{reviewNo})
	</insert>
	
	<delete id="deleteRecommend">
		delete from recommend where userId = #{userId} and reviewNo = #{reviewNo}
	</delete>
	
	<insert id="insertReview"> 
		 insert into review(title,writer,content,grade,productNo)
		 values (#{title},#{writer},#{content},#{grade},#{productNo})
	</insert>
	
	<update id="updateReview">
		update review set title = #{title}, content=#{content}, grade=#{grade} where reviewNo = #{reviewNo}
	</update>
	
	<delete id="deleteReview">
		delete from review where reviewNo = #{reviewNo}
	</delete>
	
	<update id="updateComment">
		update review_comment set comment = #{comment} where commentNo = #{commentNo}
	</update>
	
	<delete id="deleteComment">
		delete from review_comment where commentNo = #{commentNo}
	</delete> 
	
	<update id="updateCommentNum2">
		update review set commentNum = commentNum - 1 where reviewNo = #{reviewNo}
	</update>
	
	<select id="selectReviewNo" resultType="int">
		select max(reviewNo) as reviewNo from review
	</select>
	
	<insert id="insertAttachfile">
		 insert into attachfile(reviewNo,productNo,originFile,thumbnailFile,notImageFile)
		 values (#{reviewNo},#{productNo},#{originFile},#{thumbnailFile},#{notImageFile})
	</insert>
	
	<select id="selectAllAttachfile" resultType="AttachFileVO">
		select * from attachfile where productNo = #{prodNo}
	</select>
	
	<delete id="deleteAttachfile">
		delete from attachfile where attachFileNo = #{attachFileNo}
	</delete> 
	
	<select id="selectTotalPost" resultType="int">
		select count(*) as totalCnt from review where productNo = #{prodNo}
	</select>
	

	<!-- 마이페이지 내 리뷰-->
	<select id = "showMyReview" resultType = "ReviewVO" >
		select * from review where writer = #{writer}
	</select>
	
</mapper>